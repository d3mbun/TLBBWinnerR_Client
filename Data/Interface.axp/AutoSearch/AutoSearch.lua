
--µ±Ç°³¡¾°ÀàÐÍ....²»ÓÃµÄ³¡¾°ÀàÐÍËùÐèÏÔÊ¾µÄTabÒ³²»Í¬....
-- -1 ÎÞÐ§
--  0 ³ÇÊÐ   --È«²¿£¬¹¦ÄÜ£¬ÉÌµê£¬ÈÎÎñ
--  1 ÃÅÅÉ   --È«²¿£¬¹¦ÄÜ
--  2 ÐþÎäµº --È«²¿£¬ÈËÎï£¬¼ÒÊÞ£¬ÃÍÊÞ
--  3 ÆäËü   --È«²¿£¬¹ÖÎï£¬ÈËÎï
local g_CurSceneType = -1
local g_AutoSearch_Frame_UnifiedPosition;
--³ÇÊÐ³¡¾°µÄIDÁÐ±í....
local g_CitySceneIDList = { 0, 1, 2, 242, 246, 260 }
--ÃÅÅÉ³¡¾°µÄIDÁÐ±í....
local g_MenpaiSceneIDList = { 9, 10, 11, 12, 13, 14, 15, 16, 17, 284 }
--³èÎï³¡¾°µÄIDÁÐ±í....
local g_PetSceneIDList = { 112, 201 }

--µ±Ç°Ñ¡ÔñµÄTabÒ³....
local g_CurSelectTabIndex = 1;

--²»Í¬³¡¾°ÀàÐÍÏÂ¸÷¸öTab°´Å¥Ëù¶ÔÓ¦µÄ·ÖÀàÀàÐÍ....
--½çÃæÉÏÒ»¹²ÓÐ5¸öTab....
--·ÖÀàÀàÐÍ ÎÞÐ§=-1£¬È«=0£¬¹Ö=1£¬ÈË=2£¬ÊÞ=3£¬ÃÍ=4£¬¹¦=5£¬µê=6£¬ÈÎ=7£¬ÎÞ·ÖÀà±êÇ©=99
local g_TableTabIndex2TabType = {
	{	0,	5,	6,	7,	-1,	},
	{	0,	5,	-1,	-1,	-1,	},
	{	0,	2,	3,	4,	-1,	},
	{	0,	1,	2,	-1,	-1,	},
}

--ÉÏ´Î¸üÐÂ±¾´°¿ÚÊ±Íæ¼ÒËùÔÚ³¡¾°ID....
local g_LastUpdateSceneID = -1;

--¸÷¸öTabÒ³µÄ×Ô¶¯Ñ°Â·Êý¾Ý....»»³¡¾°µÄÊ±ºò²ÅÖØÐÂ¼ÆËã....
local g_TabListData = {};
g_TabListData[1] = {};
g_TabListData[2] = {};
g_TabListData[3] = {};
g_TabListData[4] = {};
g_TabListData[5] = {};


function AutoSearch_PreLoad()
	this:RegisterEvent("OPEN_AUTOSEARCH");
	this:RegisterEvent("SCENE_TRANSED");
	this:RegisterEvent("UI_COMMAND");
	this:RegisterEvent("TOGLE_AUTOSEARCH")
		-- ÓÎÏ·´°¿Ú³ß´ç·¢ÉúÁË±ä»¯
	this:RegisterEvent("ADJEST_UI_POS")
	-- ÓÎÏ··Ö±æÂÊ·¢ÉúÁË±ä»¯
	this:RegisterEvent("VIEW_RESOLUTION_CHANGED")	
end


function AutoSearch_OnLoad()

	--´°¿Ú¼ÓÔØÊ±¶¯Ì¬µÄ²åÈëÁÐ....Ö±½ÓÔÚxmlÀïÅäÖÃÁÐµÄ»°ÎÞ·¨ÒýÓÃ×Öµä....
	AutoSearch_List:AddColumn( "Danh xßng", 0, 0.6 );
	AutoSearch_List:AddColumn( "Tóm t¡t (s½ lßþc)", 1, 0.4 );

	--*****************************************
	--CEGUIÓÐÒ»´¦Ð´µÄ²»ºÏÀíµÄµØ·½(Bug?)....µ¼ÖÂ¶àÁÐÁÐ±íÉèÖÃÊôÐÔÊ±»á³öÏÖÒ»Ð©´íÎó....
	--¾ßÌåÎª£º
	--ÔÚXMLÖÐ¸ø¶àÁÐÁÐ±íÅäÖÃÁËColumnsSizable=True....¾Í»áÉèÖÃ¸Ã¿Ø¼þµÄColumnsSizable=True....»¹»áÉèÖÃÆäËùÓÐÁÐµÄColumnsSizable=True....
	--ÓÐÐ©¶àÁÐÁÐ±íÈç±¾´°¿ÚµÄÐèÒªÔÚ½Å±¾ÖÐ¶¯Ì¬µÄ²åÈëÁÐ....ÕâÊ±XMLÖÐÅäÖÃµÄColumnsSizable=TrueÖ»»áÉèÖÃ¸Ã¿Ø¼þµÄColumnsSizable=True....²»»áÉèÖÃÁÐµÄColumnsSizable=True(ÒòÎªµ±Ê±Ò»¸öÁÐ¶¼Ã»ÓÐ)....
	--Òò´ËÔÚ½Å±¾ÖÐ¶¯Ì¬²åÈëÁÐºóÁÐµÄColumnsSizableÒòÎªÃ»±»ÉèÖÃ¹ý¾Í²»ÊÇTrue....
	--Èç¹ûÏëÔÚ¶¯Ì¬²åÈëÁÐºóÔÚ½Å±¾ÀïÔÙÖØÐÂ¸ø¶àÁÐÁÐ±íÉèÖÃColumnsSizable=TrueÒ²²»ÐÐ....
	--ÒòÎªÉèÖÃ¸ÃÊôÐÔµÄÖµÊ±»áÅÐ¶ÏÊÇ·ñÓëµ±Ç°¸ÃÊôÐÔµÄÖµÒ»Ñù....Èç¹ûÒ»Ñù¾ÍÖ±½Ó·µ»Ø....¶ø¸Ã¿Ø¼þµÄColumnsSizableÔÚ³õÊ¼»¯XMLµÄÊ±ºò±»Éè³ÉTrueÁËËùÒÔ»áÖ±½Ó·µ»Ø....Ò²¾Í²»»á¸øËüµÄÁÐÉèÖÃ¸ÃÊôÐÔ....
	--Òò´ËÈç¹ûÏë¶¯Ì¬²åÈëÁÐ¾ÍÐèÒªÔÚ¶¯Ì¬²åÈëºóÔÙÉèÖÃºÍÁÐÓÐ¹ØµÄÊôÐÔ....Í¬Ê±ÔÚXMLÖÐ²»ÄÜ¶ÔºÍÁÐÓÐ¹ØµÄÊôÐÔ½øÐÐÉèÖÃ....
	--*****************************************
	AutoSearch_List:SetProperty( "ColumnsSizable", "False" );
	AutoSearch_List:SetProperty( "ColumnsAdjust", "True" );
	AutoSearch_List:SetProperty( "ColumnsMovable", "False" );
  g_AutoSearch_Frame_UnifiedPosition=AutoSearch_Frame:GetProperty("UnifiedPosition");
end

-- OnEvent
function AutoSearch_OnEvent(event)

	if ( event == "OPEN_AUTOSEARCH" ) then

		if( this:IsVisible() ) then
			this:Hide();
		else
			AutoSearch_Open();
		end

	elseif ( event == "SCENE_TRANSED" ) then

		--ÇÐ»»³¡¾°Ê±¹Ø±Õ±¾´°¿Ú
		this:Hide();
		local curSceneID = GetSceneID();
		if (curSceneID == 112) then
			AutoSearch_Open();
		end
	elseif(event == "UI_COMMAND" and tonumber(arg0)==831021) then
		if( this:IsVisible() ) then
			return;
		else
			AutoSearch_Open();
		end
	elseif ( event == "TOGLE_AUTOSEARCH" ) then
		if ( arg0 == "1" ) then
--			AutoSearch_Frame:SetProperty("UnifiedXPosition", "{1.0,-149.0}")
--			AutoSearch_Frame:SetProperty("UnifiedYPosition", "{0.0,226.0}")
			AutoSearch_Open()
		else
			this:Hide();
		end
	end

		-- ÓÎÏ·´°¿Ú³ß´ç·¢ÉúÁË±ä»¯
	if (event == "ADJEST_UI_POS" ) then
		AutoSearch_Frame_On_ResetPos()
	-- ÓÎÏ··Ö±æÂÊ·¢ÉúÁË±ä»¯
	elseif (event == "VIEW_RESOLUTION_CHANGED") then
		AutoSearch_Frame_On_ResetPos()
	end

end


--**********************************
--´ò¿ª×Ô¶¯Ñ°Â·´°¿Ú....
--**********************************
function AutoSearch_Open()
	--Çå¿Õ×ø±êÊäÈë¿ò
	InputPosition_x:SetText("");
	InputPosition_y:SetText("");
	--´ò¿ª´°¿ÚÊ±Ä¬ÈÏÊÇTab1....
	if ( true == AutoSearch_UpdateFrame(1) ) then
		--ÉèÖÃTab1°´Å¥ÎªÑ¡ÖÐ×´Ì¬....
		AutoSearch_Tab1:SetCheck(1);
		this:Show();
	else
		--Ôö¼Ó×ø±êÊäÈë·½Ê½Ö®ºó£¬µ±Ç°³¡¾°Ã»ÓÐ¿ÉÑ°Â·Ä¿±ê£¬Ò²Òªµ¯³ö£¬ËùÒÔ×¢ÊÍÏÂÃæÕâ¾ä
		--Èç¹ûÃ»ÓÐÈÎºÎ¿ÉÑ°Â·µÄÎ»ÖÃ£¬ÔòÏÔÊ¾"µ±Ç°µÄ³¡¾°Ã»ÓÐ¿ÉÑ°Â·µÄÄ¿±ê¡£"
		--PushDebugMessage("µ±Ç°µÄ³¡¾°Ã»ÓÐ¿ÉÑ°Â·µÄÄ¿±ê¡£");
		this:Show();
	end

end

--**********************************
--¸üÐÂ×Ô¶¯Ñ°Â·´°¿Ú....
--Èçµ±Ç°³¡¾°Ã»ÓÐ¿ÉÑ°Â·µÄÎ»ÖÃÔò·µ»Øfalse....
--**********************************
function AutoSearch_UpdateFrame( tabIndex )

	g_CurSelectTabIndex = tabIndex;

	--¸üÐÂÍæ¼Òµ±Ç°ËùÔÚ³¡¾°µÄ³¡¾°ÀàÐÍ....
	UpdateCurrentSceneType();

	--¸ù¾Ýµ±Ç°µÄ³¡¾°ÀàÐÍ¸üÐÂTab°´Å¥....
	UpdateTabButton();

	--¸üÐÂ×Ô¶¯Ñ°Â·ÁÐ±í....
	return UpdateList( tabIndex );

end

--**********************************
--¸üÐÂÍæ¼Òµ±Ç°ËùÔÚ³¡¾°µÄ³¡¾°ÀàÐÍ....
--**********************************
function UpdateCurrentSceneType()

	local curSceneID = GetSceneID();

	--³ÇÊÐ
	for i, sceneId in g_CitySceneIDList do
		if curSceneID == sceneId then
			g_CurSceneType = 0;
			return;
		end
	end

	--ÃÅÅÉ
	for i, sceneId in g_MenpaiSceneIDList do
		if curSceneID == sceneId then
			g_CurSceneType = 1;
			return;
		end
	end

	--³èÎï
	for i, sceneId in g_PetSceneIDList do
		if curSceneID == sceneId then
			g_CurSceneType = 2;
			return;
		end
	end

	--ÆäËü³¡¾°
	g_CurSceneType = 3;

end

--**********************************
--¸ù¾Ýµ±Ç°µÄ³¡¾°ÀàÐÍ¸üÐÂTab°´Å¥....
--**********************************
function UpdateTabButton()

	--³ÇÊÐ
	if g_CurSceneType == 0 then

		AutoSearch_Tab1:Show();
		AutoSearch_Tab2:Show();
		AutoSearch_Tab3:Show();
		AutoSearch_Tab4:Show();
		AutoSearch_Tab5:Hide();
		AutoSearch_Tab1:SetText("Toàn");
		AutoSearch_Tab2:SetText("Công");
		AutoSearch_Tab3:SetText("Ti®m");
		AutoSearch_Tab4:SetText("Nh§m");

	--ÃÅÅÉ
	elseif g_CurSceneType == 1 then

		AutoSearch_Tab1:Show();
		AutoSearch_Tab2:Show();
		AutoSearch_Tab3:Hide();
		AutoSearch_Tab4:Hide();
		AutoSearch_Tab5:Hide();
		AutoSearch_Tab1:SetText("Toàn");
		AutoSearch_Tab2:SetText("Công");

	--³èÎï
	elseif g_CurSceneType == 2 then

		AutoSearch_Tab1:Show();
		AutoSearch_Tab2:Show();
		AutoSearch_Tab3:Show();
		AutoSearch_Tab4:Show();
		AutoSearch_Tab5:Hide();
		AutoSearch_Tab1:SetText("Toàn");
		AutoSearch_Tab2:SetText("Nhân");
		AutoSearch_Tab3:SetText("Thú");
		AutoSearch_Tab4:SetText("Mãnh");

	--ÆäËü
	elseif g_CurSceneType == 3 then

		AutoSearch_Tab1:Show();
		AutoSearch_Tab2:Show();
		AutoSearch_Tab3:Show();
		AutoSearch_Tab4:Hide();
		AutoSearch_Tab5:Hide();
		AutoSearch_Tab1:SetText("Toàn");
		AutoSearch_Tab2:SetText("Quái");
		AutoSearch_Tab3:SetText("Nhân");

	end

end

--**********************************
--¸üÐÂ×Ô¶¯Ñ°Â·ÁÐ±í....
--Èç¹ûµ±Ç°³¡¾°Ã»ÓÐ¿ÉÑ°Â·µÄÎ»ÖÃÔò·µ»Øfalse....
--**********************************
function UpdateList( tabIndex )

	--Çå¿ÕList¿Ø¼þÖÐµÄÄÚÈÝ....
	AutoSearch_List:RemoveAllItem();

	--Èç¹û´ÓÉÏ´Î¸üÐÂÊý¾ÝÖ®ºó³¡¾°¸Ä±äÁË....ÔòÇå¿ÕÉÏ´Î¼ÆËãºÃµÄ¸÷TabÒ³µÄ×Ô¶¯Ñ°Â·Êý¾Ý....
	local curSceneID = GetSceneID();
	if g_LastUpdateSceneID ~= curSceneID then
		g_TabListData[1] = nil;
		g_TabListData[2] = nil;
		g_TabListData[3] = nil;
		g_TabListData[4] = nil;
		g_TabListData[5] = nil;
		g_LastUpdateSceneID = curSceneID;
	end

	--»ñÈ¡ÅäÖÃÎÄ¼þÖÐ....±¾³¡¾°×Ô¶¯Ñ°Â·Êý¾ÝµÄÆðÊ¼Óë½áÊøÎ»ÖÃ....
	local nStart, nEnd = DataPool:GetAutoSearchSceneStartEnd( GetSceneID() )

	--Èç¹û±¾³¡¾°Ã»ÓÐ¿ÉÑ°Â·µÄÎ»ÖÃÔò·µ»Øfalse....
	if nStart == -1 then
		return false;
	end

	--Èç¹ûÃ»ÓÐ±¾TabÒ³µÄ×Ô¶¯Ñ°Â·Êý¾ÝÔòÖØÐÂ¼ÆËã....
	local g_TabListDataTablePtr = g_TabListData[tabIndex];

	if not g_TabListDataTablePtr then

		----PushDebugMessage("±¾tabÒ³µÄÊý¾Ý»¹Ã»ÓÐ£¬µÃÖØËã")
		g_TabListData[tabIndex] = {};
		g_TabListDataTablePtr = g_TabListData[tabIndex];

		--Ìî³ä±¾³¡¾°×Ô¶¯Ñ°Â·Êý¾ÝµÄIDºÍÓÅÏÈ¼¶µ½±í¸ñ....
		local tblPriority = {};
		local nCount = nEnd - nStart + 1;
		local k = 1;
		for i=nStart, nEnd do
			tblPriority[k] = {};
			tblPriority[k].id = i;
			tblPriority[k].pri = DataPool:GetAutoSearchPriority(i);
			k = k + 1;
		end

		--°´ÓÅÏÈ¼¶¶Ô±í¸ñ½øÐÐÅÅÐò....
		--Ëã·¨ÓÐµã²»ºÃÀí½â....²ß»®ÒªÇóÈ¨ÖµÏàÍ¬µÄÅÅÐòºóÏà¶ÔÎ»ÖÃ²»ÄÜ¸Ä±ä....¾ÍÏÈÕâÃ´Ð´ÁË....
		local temp1,temp2;
		for m=nCount, 1, -1 do
			for n=m-1, 1, -1 do
				if tblPriority[m].pri >= tblPriority[n].pri then
					temp1 = tblPriority[m].id;
					temp2 = tblPriority[m].pri;
					tblPriority[m].id = tblPriority[n].id;
					tblPriority[m].pri = tblPriority[n].pri;
					tblPriority[n].id = temp1;
					tblPriority[n].pri = temp2;
				end
			end
		end

		--°´ÅÅÐòºóµÄIDË³Ðò½«×Ô¶¯Ñ°Â·µÄÊý¾Ý¼Óµ½±¾TabÒ³µÄ×Ô¶¯Ñ°Â·Êý¾Ý±íÖÐ....
		local curTabType = TabIndex2TabType(tabIndex);
		local x, y, name, tooltips, info, tabtype;
		k = 1;
		for i=1, nCount do
			x, y, name, tooltips, info, tabtype = DataPool:GetAutoSearch( tblPriority[nCount-i+1].id );
			if 0 == curTabType or curTabType == tabtype then
				g_TabListDataTablePtr[k] = {};
				g_TabListDataTablePtr[k].ID = tblPriority[nCount-i+1].id;
				g_TabListDataTablePtr[k].nPosX = x;
				g_TabListDataTablePtr[k].nPosY = y;
				g_TabListDataTablePtr[k].strName = name;
				g_TabListDataTablePtr[k].strToolTips = tooltips;
				g_TabListDataTablePtr[k].strInfo = info;
				--g_TabListDataTablePtr[k].strInfo = tostring(tblPriority[nCount-i+1].pri).."£¬"..tostring(tblPriority[nCount-i+1].id);
				k = k + 1;
			end
		end

	end --end of (if not g_TabListDataTablePtr then)

	--Ìî³ä±¾Ò³µÄ×Ô¶¯Ñ°Â·Êý¾Ýµ½ListÖÐ....
	local nTabListCount = table.getn( g_TabListDataTablePtr );
	----PushDebugMessage("count ="..tostring(nTabListCount) )
	for i=1, nTabListCount do
		AutoSearch_List:AddNewItem( g_TabListDataTablePtr[i].strName, 0, i-1 );
		AutoSearch_List:AddNewItem( g_TabListDataTablePtr[i].strInfo, 1, i-1 );
		AutoSearch_List:SetRowTooltip( i-1, g_TabListDataTablePtr[i].strToolTips );
	end

	return true;

end

--**********************************
--»ñÈ¡ÔÚµ±Ç°³¡¾°ÏÂÖ¸¶¨Tab°´Å¥Ëù¶ÔÓ¦µÄ·ÖÀàÀàÐÍ....
--**********************************
function TabIndex2TabType( tabIndex )

	if g_CurSceneType ~= -1 and tabIndex >= 1 and tabIndex <= 5 then
		return g_TableTabIndex2TabType[g_CurSceneType+1][tabIndex];
	else
		return -1;
	end

end

--**********************************
--×Ô¶¯Ñ°Â·µ½Ö¸¶¨×ø±ê....
--**********************************
function AutoMoveTo()
	local nPosX = tonumber(InputPosition_x:GetText());
	local nPosY = tonumber(InputPosition_y:GetText());
	if not nPosX or nPosX <= 0 or not nPosY or nPosY <= 0 then
		return;
	end

	--»ñÈ¡µ±Ç°TabÒ³µÄ×Ô¶¯Ñ°Â·Êý¾Ý....
	local str = GetDictionaryString("ZDXL_90520_2")
	AutoRunToTarget(nPosX, nPosY)
	local TabListDataTablePtr = g_TabListData[g_CurSelectTabIndex];
	if TabListDataTablePtr then
		--Ñ¡ÖÐÁËµÚ¼¸Ïî....
		local nSelIndex = AutoSearch_List:GetSelectItem();
		if nSelIndex >= 0 then
			nSelIndex = nSelIndex + 1;
			if TabListDataTablePtr[nSelIndex].nPosX == nPosX and TabListDataTablePtr[nSelIndex].nPosY == nPosY then
				--ÉèÖÃÄ¿±êNPCµÄÃû×Ö£¬µ½´ï¸ÃNPC´¦ºó»á×Ô¶¯ÓëÆä¶Ô»°
				SetAutoRunTargetNPCName( TabListDataTablePtr[nSelIndex].strName );
				AutoRunToTarget(nPosX, nPosY)
			end
		end
	end

	--×Ô¶¯ÒÆ¶¯µ½Ö¸¶¨Î»ÖÃ
	local ret = AutoRunToTarget( nPosX, nPosY );
	if ret == 0 then
		PushDebugMessage("#{ZDXL_90520_3}")
	end
end

--**********************************
--Ë«»÷....
--**********************************
function OnDoubleClick()
	local TabListDataTablePtr = g_TabListData[g_CurSelectTabIndex];
	if TabListDataTablePtr then
		--Ñ¡ÖÐÁËµÚ¼¸Ïî....
		local nSelIndex = AutoSearch_List:GetSelectItem();
		if nSelIndex >= 0 then
		--Ö»ÓÐµ±ÓÐÑ¡ÖÐÏîÊ±£¬²ÅÏìÓ¦Ë«»÷ÐÅÏ¢£¬·ÀÖ¹³öÏÖË«»÷¿ÕÁÐ±íÀ¸Ò²ÒÆ¶¯µÄÇé¿ö
			AutoMoveTo()
		end
	end
end

--****************************************
--¿½±´×Ô¶¯Ñ°Â·ÁÐ±íÖÐµÄNPC×ø±êµ½×ø±êÊäÈë¿ò
--****************************************
function CopyPosition()

	--»ñÈ¡µ±Ç°TabÒ³µÄ×Ô¶¯Ñ°Â·Êý¾Ý....
	local TabListDataTablePtr = g_TabListData[g_CurSelectTabIndex];
	if not TabListDataTablePtr then
		return;
	end

	--Ñ¡ÖÐÁËµÚ¼¸Ïî....
	local nSelIndex = AutoSearch_List:GetSelectItem();
	if nSelIndex < 0 then
		return;
	end

	nSelIndex = nSelIndex + 1;
	local strPosX = tostring(TabListDataTablePtr[nSelIndex].nPosX);
	local strPosY = tostring(TabListDataTablePtr[nSelIndex].nPosY);
	InputPosition_x:SetText(strPosX);
	InputPosition_y:SetText(strPosY);
end


--================================================
-- »Ö¸´½çÃæµÄÄ¬ÈÏÏà¶ÔÎ»ÖÃ
--================================================
function AutoSearch_Frame_On_ResetPos()
  AutoSearch_Frame:SetProperty("UnifiedPosition", g_AutoSearch_Frame_UnifiedPosition);
end

function AutoSearch_XEnter()
	if (this:IsVisible()) then
		InputPosition_y:SetProperty("DefaultEditBox", "True");
		InputPosition_x:SetProperty("DefaultEditBox", "False");
	end
end

function AutoSearch_YEnter()
	if (this:IsVisible()) then
		AutoMoveTo()
	end
end


